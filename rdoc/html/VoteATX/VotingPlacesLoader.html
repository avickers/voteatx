<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class VoteATX::VotingPlacesLoader - VoteATX</title>

<link type="text/css" media="screen" href="../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
</script>

<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="../index.html">Home</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  

  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/voteatx/loader.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">Object
  
</nav>

    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-i-add_schedule_entry">#add_schedule_entry</a>
    
    <li ><a href="#method-i-append_schedule">#append_schedule</a>
    
    <li ><a href="#method-i-cleanup_row">#cleanup_row</a>
    
    <li ><a href="#method-i-create_tables">#create_tables</a>
    
    <li ><a href="#method-i-ensure_not_empty">#ensure_not_empty</a>
    
    <li ><a href="#method-i-format_date">#format_date</a>
    
    <li ><a href="#method-i-format_schedule">#format_schedule</a>
    
    <li ><a href="#method-i-format_schedule_line">#format_schedule_line</a>
    
    <li ><a href="#method-i-format_time">#format_time</a>
    
    <li ><a href="#method-i-get_date">#get_date</a>
    
    <li ><a href="#method-i-get_datetimes">#get_datetimes</a>
    
    <li ><a href="#method-i-get_time">#get_time</a>
    
    <li ><a href="#method-i-is_closed_today">#is_closed_today</a>
    
    <li ><a href="#method-i-load_eday_places">#load_eday_places</a>
    
    <li ><a href="#method-i-load_evfixed_places">#load_evfixed_places</a>
    
    <li ><a href="#method-i-load_evmobile_places">#load_evmobile_places</a>
    
    <li ><a href="#method-i-make_location">#make_location</a>
    
    <li ><a href="#method-i-make_schedule">#make_schedule</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="../README-data_rdoc.html">README-data</a>
  
    <li class="file"><a href="../README_rdoc.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="../Array.html">Array</a>
  
    <li><a href="../NilClass.html">NilClass</a>
  
    <li><a href="../String.html">String</a>
  
    <li><a href="../VoteATX.html">VoteATX</a>
  
    <li><a href="../VoteATX/Finder.html">VoteATX::Finder</a>
  
    <li><a href="../VoteATX/Service.html">VoteATX::Service</a>
  
    <li><a href="../VoteATX/Service/Sinatra.html">VoteATX::Service::Sinatra</a>
  
    <li><a href="../VoteATX/VotingDistrictsLoader.html">VoteATX::VotingDistrictsLoader</a>
  
    <li><a href="../VoteATX/VotingPlace.html">VoteATX::VotingPlace</a>
  
    <li><a href="../VoteATX/VotingPlace/Base.html">VoteATX::VotingPlace::Base</a>
  
    <li><a href="../VoteATX/VotingPlace/Early.html">VoteATX::VotingPlace::Early</a>
  
    <li><a href="../VoteATX/VotingPlace/ElectionDay.html">VoteATX::VotingPlace::ElectionDay</a>
  
    <li><a href="../VoteATX/VotingPlacesLoader.html">VoteATX::VotingPlacesLoader</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class VoteATX::VotingPlacesLoader</h1>

  <div id="description" class="description">
    
<p>Load a Spatialite database with voting place information from spreadsheets.</p>

<p>The database must already exist, and must already be initialized with the
geospatial tables.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="DEFAULT_COL_NAMES">DEFAULT_COL_NAMES
        
        <dd class="description"><p>Default mapping of data columns to spreadsheet column names</p>
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-col_name" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">col_name</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Mapping of data columns to spreadsheet column names</p>
        
        </div>
      </div>
      
      <div id="attribute-i-db" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">db</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Spatialite database instance</p>
        
        </div>
      </div>
      
      <div id="attribute-i-dbname" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">dbname</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Name of the database we are creating</p>
        
        </div>
      </div>
      
      <div id="attribute-i-debug" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">debug</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>True if loader instance was constructed with :debug flag</p>
        
        </div>
      </div>
      
      <div id="attribute-i-election_description" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">election_description</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>A one-line description of the election</p>

<p>Example: “for the Nov 5, 2013 general election in Travis County”</p>

<p>In the <a href="../VoteATX.html">VoteATX</a> app this is displayed below
the title of the voting place (e.g. “Precinct 31415”).</p>
        
        </div>
      </div>
      
      <div id="attribute-i-election_info" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">election_info</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Additional information about the election.</p>

<p>This is included near the bottom of the info window that is opened up for a
voting place. Full HTML is supported. Line breaks automatically inserted.</p>

<p>This would be a good place to put a link to the official county voting page
for this election.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-log" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">log</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Logger instance</p>
        
        </div>
      </div>
      
      <div id="attribute-i-valid_lat_range" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">valid_lat_range</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Numeric range for valid latitude (degrees) values</p>
        
        </div>
      </div>
      
      <div id="attribute-i-valid_lng_range" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">valid_lng_range</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Numeric range for valid longitude (degrees) values</p>
        
        </div>
      </div>
      
      <div id="attribute-i-valid_zip_regexp" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">valid_zip_regexp</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Regexp to validate zipcode values</p>
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(dbname, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Create a new loader instance.</p>

<p>The “dbname” is the name of the Spatialiate database to load. It must
already exist and it must already be initialized with geospatial tables.</p>

<p>Options:</p>
<ul><li>
<p>:log - A Logger instance.</p>
</li><li>
<p>:debug - If true, database operations will be logged.</p>
</li></ul>
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 168</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">dbname</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-ivar">@dbname</span> = <span class="ruby-identifier">dbname</span>
  <span class="ruby-ivar">@debug</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value">:debug</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:debug</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@log</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:log</span>) <span class="ruby-operator">||</span> <span class="ruby-constant">Logger</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">$stderr</span>)
  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">level</span> = (<span class="ruby-ivar">@debug</span> <span class="ruby-operator">?</span> <span class="ruby-constant">Logger</span><span class="ruby-operator">::</span><span class="ruby-constant">DEBUG</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Logger</span><span class="ruby-operator">::</span><span class="ruby-constant">INFO</span>)

  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;database \&quot;#{@dbname}\&quot; file does not exist&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-ivar">@dbname</span>)
  <span class="ruby-ivar">@db</span> = <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">spatialite</span>(<span class="ruby-ivar">@dbname</span>)
  <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">logger</span> = <span class="ruby-ivar">@log</span>
  <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">sql_log_level</span> = <span class="ruby-value">:debug</span>

  <span class="ruby-ivar">@col_name</span> = <span class="ruby-constant">DEFAULT_COL_NAMES</span>.<span class="ruby-identifier">dup</span>
  <span class="ruby-ivar">@valid_lng_range</span> = <span class="ruby-value">-180</span> <span class="ruby-operator">..</span> <span class="ruby-value">180</span>
  <span class="ruby-ivar">@valid_lat_range</span> = <span class="ruby-value">-180</span> <span class="ruby-operator">..</span> <span class="ruby-value">180</span>
  <span class="ruby-ivar">@valid_zip_regexp</span> = <span class="ruby-regexp">/^\d\d\d\d\d(-\d\d\d\d)?$/</span>

  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;loading database \&quot;#{@dbname}\&quot; ...&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-add_schedule_entry" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_schedule_entry</span><span
            class="method-args">(id, h)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="add_schedule_entry-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 407</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_schedule_entry</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">h</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad schedule range: #{h}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">yday</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">yday</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">year</span>
  <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_schedule_entries</span>] <span class="ruby-operator">&lt;&lt;</span> {
    <span class="ruby-value">:schedule_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>,
    <span class="ruby-value">:opens</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>,
    <span class="ruby-value">:closes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">last</span>,
  }
  <span class="ruby-identifier">id</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_schedule_entry-source -->
          
        </div>

        

        
      </div><!-- add_schedule_entry-method -->

    
      <div id="method-i-append_schedule" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">append_schedule</span><span
            class="method-args">(id, hours)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="append_schedule-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 401</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">append_schedule</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">hours</span>)
  <span class="ruby-identifier">add_schedule_entry</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">hours</span>)
  <span class="ruby-identifier">sched</span> = <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_schedules</span>].<span class="ruby-identifier">filter</span>(<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>)
  <span class="ruby-identifier">sched</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:formatted</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sched</span>.<span class="ruby-identifier">get</span>(<span class="ruby-value">:formatted</span>) <span class="ruby-operator">+</span> <span class="ruby-string">&quot;\n&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">format_schedule_line</span>(<span class="ruby-identifier">hours</span>))
<span class="ruby-keyword">end</span></pre>
          </div><!-- append_schedule-source -->
          
        </div>

        

        
      </div><!-- append_schedule-method -->

    
      <div id="method-i-cleanup_row" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cleanup_row</span><span
            class="method-args">(row)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Cleanup a row of data read from the spreadsheet.</p>
          
          

          
          <div class="method-source-code" id="cleanup_row-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 188</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cleanup_row</span>(<span class="ruby-identifier">row</span>)
  <span class="ruby-identifier">row</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">cleanup</span>}

  <span class="ruby-comment"># Convert &quot;Combined @ 109 Parmer Lane Elementary School&quot; -&gt; &quot;Parmer Lane Elementary School&quot;</span>
  <span class="ruby-identifier">row</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:SITE_NAME</span>]].<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/^Combined\s+@\s+\d+\s+/</span>, <span class="ruby-string">&quot;&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- cleanup_row-source -->
          
        </div>

        

        
      </div><!-- cleanup_row-method -->

    
      <div id="method-i-create_tables" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_tables</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Initialize all the tables</p>
          
          

          
          <div class="method-source-code" id="create_tables-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 285</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">create_tables</span>
  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">info</span>(<span class="ruby-string">&quot;create_tables: creating database tables ...&quot;</span>)

  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-string">&quot;create_tables: creating table \&quot;election_defs\&quot; ...&quot;</span>)
  <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">create_table</span> <span class="ruby-value">:election_defs</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">String</span> <span class="ruby-value">:name</span>, <span class="ruby-value">:index</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">16</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">Text</span> <span class="ruby-value">:value</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@db</span>[<span class="ruby-value">:election_defs</span>] <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;ELECTION_DESCRIPTION&quot;</span>, <span class="ruby-value">:value</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@election_description</span>}
  <span class="ruby-ivar">@db</span>[<span class="ruby-value">:election_defs</span>] <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;ELECTION_INFO&quot;</span>, <span class="ruby-value">:value</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@election_info</span>}

  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-string">&quot;create_tables: creating table \&quot;voting_locations\&quot; ...&quot;</span>)
  <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">create_table</span> <span class="ruby-value">:voting_locations</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>
    <span class="ruby-constant">String</span> <span class="ruby-value">:name</span>, <span class="ruby-value">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">20</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">String</span> <span class="ruby-value">:street</span>, <span class="ruby-value">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">40</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">String</span> <span class="ruby-value">:city</span>, <span class="ruby-value">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">20</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">String</span> <span class="ruby-value">:state</span>, <span class="ruby-value">:size=</span><span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">String</span> <span class="ruby-value">:zip</span>, <span class="ruby-value">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">Text</span> <span class="ruby-value">:formatted</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">rc</span> = <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">get</span>{<span class="ruby-constant">AddGeometryColumn</span>(<span class="ruby-string">'voting_locations'</span>, <span class="ruby-string">'geometry'</span>, <span class="ruby-value">4326</span>, <span class="ruby-string">'POINT'</span>, <span class="ruby-string">'XY'</span>)}
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;AddGeometryColumn failed (rc=#{rc})&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rc</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">rc</span> = <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">get</span>{<span class="ruby-constant">CreateSpatialIndex</span>(<span class="ruby-string">'voting_locations'</span>, <span class="ruby-string">'geometry'</span>)}
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;CreateSpatialIndex failed (rc=#{rc})&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rc</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>

  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-string">&quot;create_tables: creating table \&quot;voting_schedules\&quot; ...&quot;</span>)
  <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">create_table</span> <span class="ruby-value">:voting_schedules</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>
    <span class="ruby-constant">Text</span> <span class="ruby-value">:formatted</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-string">&quot;create_tables: creating table \&quot;voting_schedule_entries\&quot; ...&quot;</span>)
  <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">create_table</span> <span class="ruby-value">:voting_schedule_entries</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>
    <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:schedule_id</span>, <span class="ruby-value">:voting_schedules</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">DateTime</span> <span class="ruby-value">:opens</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:index</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
    <span class="ruby-constant">DateTime</span> <span class="ruby-value">:closes</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:index</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-string">&quot;create_tables: creating table \&quot;voting_places\&quot; ...&quot;</span>)
  <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">create_table</span> <span class="ruby-value">:voting_places</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>
    <span class="ruby-constant">String</span> <span class="ruby-value">:place_type</span>, <span class="ruby-value">:index</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">16</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">String</span> <span class="ruby-value">:title</span>, <span class="ruby-value">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">80</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">Integer</span> <span class="ruby-value">:precinct</span>, <span class="ruby-value">:unique</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
    <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:location_id</span>, <span class="ruby-value">:voting_locations</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:schedule_id</span>, <span class="ruby-value">:voting_schedules</span>, <span class="ruby-value">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
    <span class="ruby-constant">Text</span> <span class="ruby-value">:notes</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_tables-source -->
          
        </div>

        

        
      </div><!-- create_tables-method -->

    
      <div id="method-i-ensure_not_empty" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_not_empty</span><span
            class="method-args">(row, *cols)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Assert that the spreadsheet row has non-empty values for each of the
specifieid columns.</p>
          
          

          
          <div class="method-source-code" id="ensure_not_empty-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 196</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ensure_not_empty</span>(<span class="ruby-identifier">row</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">cols</span>)
  <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">col</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;required column \&quot;#{col}\&quot; not defined: #{row}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">row</span>[<span class="ruby-identifier">col</span>].<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ensure_not_empty-source -->
          
        </div>

        

        
      </div><!-- ensure_not_empty-method -->

    
      <div id="method-i-format_date" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">format_date</span><span
            class="method-args">(t)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Format the date portion of a Time value to a <a
href="../String.html">String</a></p>
          
          

          
          <div class="method-source-code" id="format_date-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 275</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">format_date</span>(<span class="ruby-identifier">t</span>)
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%a, %b %-d&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- format_date-source -->
          
        </div>

        

        
      </div><!-- format_date-method -->

    
      <div id="method-i-format_schedule" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">format_schedule</span><span
            class="method-args">(hours)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Given a list of open..close Time ranges, produce a display as a list of <a
href="../String.html">String</a> values.</p>
          
          

          
          <div class="method-source-code" id="format_schedule-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 232</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">format_schedule</span>(<span class="ruby-identifier">hours</span>)
  <span class="ruby-identifier">sched</span> = []
  <span class="ruby-identifier">curr</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">hours</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span>

    <span class="ruby-identifier">date</span> = <span class="ruby-identifier">format_date</span>(<span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>)
    <span class="ruby-identifier">hours</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_closed_today</span>(<span class="ruby-identifier">h</span>)
        <span class="ruby-string">&quot;closed&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">format_time</span>(<span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>) <span class="ruby-operator">+</span> <span class="ruby-string">&quot; - &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">format_time</span>(<span class="ruby-identifier">h</span>.<span class="ruby-identifier">last</span>)
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">curr</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">curr</span>[<span class="ruby-value">:hours</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">hours</span>
        <span class="ruby-identifier">curr</span>[<span class="ruby-value">:date_last</span>] = <span class="ruby-identifier">date</span>
        <span class="ruby-identifier">curr</span>[<span class="ruby-value">:formatted</span>] = <span class="ruby-identifier">curr</span>[<span class="ruby-value">:date_first</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot; - &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">curr</span>[<span class="ruby-value">:date_last</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot;: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">curr</span>[<span class="ruby-value">:hours</span>]
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">sched</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">curr</span>[<span class="ruby-value">:formatted</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">curr</span> = {
      <span class="ruby-value">:date_first</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">date</span>,
      <span class="ruby-value">:date_last</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">date</span>,
      <span class="ruby-value">:hours</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">hours</span>,
      <span class="ruby-value">:formatted</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">date</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">hours</span>,
    }

  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sched</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">curr</span>[<span class="ruby-value">:formatted</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">curr</span>
  <span class="ruby-identifier">sched</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- format_schedule-source -->
          
        </div>

        

        
      </div><!-- format_schedule-method -->

    
      <div id="method-i-format_schedule_line" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">format_schedule_line</span><span
            class="method-args">(h)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Given an open..close Time range, format the hours that day as a <a
href="../String.html">String</a></p>
          
          

          
          <div class="method-source-code" id="format_schedule_line-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 266</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">format_schedule_line</span>(<span class="ruby-identifier">h</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_closed_today</span>(<span class="ruby-identifier">h</span>)
    <span class="ruby-identifier">format_date</span>(<span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>) <span class="ruby-operator">+</span> <span class="ruby-string">&quot;: closed&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">format_date</span>(<span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>) <span class="ruby-operator">+</span> <span class="ruby-string">&quot;: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">format_time</span>(<span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>) <span class="ruby-operator">+</span> <span class="ruby-string">&quot; - &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">format_time</span>(<span class="ruby-identifier">h</span>.<span class="ruby-identifier">last</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- format_schedule_line-source -->
          
        </div>

        

        
      </div><!-- format_schedule_line-method -->

    
      <div id="method-i-format_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">format_time</span><span
            class="method-args">(t)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Format the time portion of a Time value to a <a
href="../String.html">String</a></p>
          
          

          
          <div class="method-source-code" id="format_time-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 280</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">format_time</span>(<span class="ruby-identifier">t</span>)
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%-l:%M%P&quot;</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/:00([ap]m)/</span>, <span class="ruby-string">&quot;\\1&quot;</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/12am/</span>, <span class="ruby-string">'midnight'</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/12pm/</span>, <span class="ruby-string">'noon'</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- format_time-source -->
          
        </div>

        

        
      </div><!-- format_time-method -->

    
      <div id="method-i-get_date" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_date</span><span
            class="method-args">(row, col)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Extract date as [mm,dd,yyyy] from specified col, in form “MM/DD/YYYY”</p>
          
          

          
          <div class="method-source-code" id="get_date-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 203</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_date</span>(<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>)
  <span class="ruby-identifier">ensure_not_empty</span>(<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>)
  <span class="ruby-identifier">m</span> = <span class="ruby-identifier">row</span>[<span class="ruby-identifier">col</span>].<span class="ruby-identifier">match</span>(<span class="ruby-regexp">%r[^(\d\d)/(\d{1,2})/(\d\d\d\d)$]</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad #{col} value \&quot;#{row[col]}\&quot;: #{row}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">-</span><span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>
  <span class="ruby-identifier">m</span>.<span class="ruby-identifier">captures</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_i</span>}
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_date-source -->
          
        </div>

        

        
      </div><!-- get_date-method -->

    
      <div id="method-i-get_datetimes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_datetimes</span><span
            class="method-args">(row)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Produce (start_time .. end_time) range from info in database record</p>
          
          

          
          <div class="method-source-code" id="get_datetimes-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 219</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_datetimes</span>(<span class="ruby-identifier">row</span>)
  <span class="ruby-identifier">mm</span>, <span class="ruby-identifier">dd</span>, <span class="ruby-identifier">yyyy</span> = <span class="ruby-identifier">get_date</span>(<span class="ruby-identifier">row</span>, <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:SCHEDULE_DATE</span>])
  <span class="ruby-identifier">start_hh</span>, <span class="ruby-identifier">start_mm</span> = <span class="ruby-identifier">get_time</span>(<span class="ruby-identifier">row</span>, <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:SCHEDULE_TIME_OPENS</span>])
  <span class="ruby-identifier">end_hh</span>, <span class="ruby-identifier">end_mm</span> = <span class="ruby-identifier">get_time</span>(<span class="ruby-identifier">row</span>, <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:SCHEDULE_TIME_CLOSES</span>])
  <span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">yyyy</span>, <span class="ruby-identifier">mm</span>, <span class="ruby-identifier">dd</span>, <span class="ruby-identifier">start_hh</span>, <span class="ruby-identifier">start_mm</span>) <span class="ruby-operator">..</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">yyyy</span>, <span class="ruby-identifier">mm</span>, <span class="ruby-identifier">dd</span>, <span class="ruby-identifier">end_hh</span>, <span class="ruby-identifier">end_mm</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_datetimes-source -->
          
        </div>

        

        
      </div><!-- get_datetimes-method -->

    
      <div id="method-i-get_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_time</span><span
            class="method-args">(row, col)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Extract time as [hh,mm] from specified col, in form “HH:MM”</p>
          
          

          
          <div class="method-source-code" id="get_time-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 211</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_time</span>(<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>)
  <span class="ruby-identifier">ensure_not_empty</span>(<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>)
  <span class="ruby-identifier">m</span> = <span class="ruby-identifier">row</span>[<span class="ruby-identifier">col</span>].<span class="ruby-identifier">match</span>(<span class="ruby-regexp">%r[^(\d{1,2}):(\d\d)$]</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad #{col} value \&quot;#{row[col]}\&quot;: #{row}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">-</span><span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
  <span class="ruby-identifier">m</span>.<span class="ruby-identifier">captures</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_i</span>}
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_time-source -->
          
        </div>

        

        
      </div><!-- get_time-method -->

    
      <div id="method-i-is_closed_today" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_closed_today</span><span
            class="method-args">(h)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Determine if an open..close Time range is the indicator for a closed day
(0:00 to 0:00).</p>
          
          

          
          <div class="method-source-code" id="is_closed_today-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 227</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_closed_today</span>(<span class="ruby-identifier">h</span>)
  <span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">hour</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">min</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_closed_today-source -->
          
        </div>

        

        
      </div><!-- is_closed_today-method -->

    
      <div id="method-i-load_eday_places" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_eday_places</span><span
            class="method-args">(infile, hours)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="load_eday_places-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 418</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_eday_places</span>(<span class="ruby-identifier">infile</span>, <span class="ruby-identifier">hours</span>)
  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;load_eday_places: loading \&quot;#{infile}\&quot; ...&quot;</span>)

  <span class="ruby-comment"># Create schedule record for election day.</span>
  <span class="ruby-identifier">schedule</span> = <span class="ruby-identifier">make_schedule</span>([<span class="ruby-identifier">hours</span>])

  <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">foreach</span>(<span class="ruby-identifier">infile</span>, <span class="ruby-value">:headers</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>

    <span class="ruby-identifier">cleanup_row</span>(<span class="ruby-identifier">row</span>)

    <span class="ruby-identifier">ensure_not_empty</span>(<span class="ruby-identifier">row</span>, <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:PCT</span>])
    <span class="ruby-identifier">precinct</span> = <span class="ruby-identifier">row</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:PCT</span>]].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;failed to parse precinct from: #{row}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">precinct</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>

    <span class="ruby-identifier">location</span> = <span class="ruby-identifier">make_location</span>(<span class="ruby-identifier">row</span>)

    <span class="ruby-identifier">notes</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">row</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:COMBINED_PCTS</span>]].<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">a</span> = [<span class="ruby-identifier">precinct</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">row</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:COMBINED_PCTS</span>]].<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>).<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_i</span>}
      <span class="ruby-identifier">notes</span> = <span class="ruby-string">&quot;Combined precincts &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_places</span>] <span class="ruby-operator">&lt;&lt;</span> {
      <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;ELECTION_DAY&quot;</span>,
      <span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;Precinct #{precinct}&quot;</span>,
      <span class="ruby-value">:precinct</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">precinct</span>,
      <span class="ruby-value">:location_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">location</span>[<span class="ruby-value">:id</span>],
      <span class="ruby-value">:schedule_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">schedule</span>[<span class="ruby-value">:id</span>],
      <span class="ruby-value">:notes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">notes</span>,
    }

  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- load_eday_places-source -->
          
        </div>

        

        
      </div><!-- load_eday_places-method -->

    
      <div id="method-i-load_evfixed_places" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_evfixed_places</span><span
            class="method-args">(infile, hours_by_code)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="load_evfixed_places-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 453</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_evfixed_places</span>(<span class="ruby-identifier">infile</span>, <span class="ruby-identifier">hours_by_code</span>)
  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;load_evfixed_places: loading \&quot;#{infile}\&quot; ...&quot;</span>)

  <span class="ruby-comment"># Create schedule records and formatted displays for early voting schedules.</span>
  <span class="ruby-identifier">schedule_by_code</span> = {}
  <span class="ruby-identifier">hours_by_code</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">code</span>, <span class="ruby-identifier">hours</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">schedule_by_code</span>[<span class="ruby-identifier">code</span>] = <span class="ruby-identifier">make_schedule</span>(<span class="ruby-identifier">hours</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">foreach</span>(<span class="ruby-identifier">infile</span>, <span class="ruby-value">:headers</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>

    <span class="ruby-identifier">cleanup_row</span>(<span class="ruby-identifier">row</span>)

    <span class="ruby-identifier">location</span> = <span class="ruby-identifier">make_location</span>(<span class="ruby-identifier">row</span>)

    <span class="ruby-identifier">schedule_code</span> = <span class="ruby-identifier">row</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:SCHEDULE_CODE</span>]]
    <span class="ruby-identifier">schedule</span> = <span class="ruby-identifier">schedule_by_code</span>[<span class="ruby-identifier">schedule_code</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown schedule code \&quot;#{schedule_code}\&quot;: #{row}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">schedule</span>

    <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_places</span>] <span class="ruby-operator">&lt;&lt;</span> {
      <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;EARLY_FIXED&quot;</span>,
      <span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Early Voting Location&quot;</span>,
      <span class="ruby-value">:location_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">location</span>[<span class="ruby-value">:id</span>],
      <span class="ruby-value">:schedule_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">schedule</span>[<span class="ruby-value">:id</span>],
      <span class="ruby-value">:notes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">nil</span>,
    }

  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- load_evfixed_places-source -->
          
        </div>

        

        
      </div><!-- load_evfixed_places-method -->

    
      <div id="method-i-load_evmobile_places" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_evmobile_places</span><span
            class="method-args">(infile)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="load_evmobile_places-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 484</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_evmobile_places</span>(<span class="ruby-identifier">infile</span>)
  <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;load_evmobile_places: loading \&quot;#{infile}\&quot; ...&quot;</span>)

  <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">foreach</span>(<span class="ruby-identifier">infile</span>, <span class="ruby-value">:headers</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>

    <span class="ruby-identifier">cleanup_row</span>(<span class="ruby-identifier">row</span>)

    <span class="ruby-identifier">location</span> = <span class="ruby-identifier">make_location</span>(<span class="ruby-identifier">row</span>)

    <span class="ruby-identifier">hours</span> = <span class="ruby-identifier">get_datetimes</span>(<span class="ruby-identifier">row</span>)

    <span class="ruby-identifier">place</span> = <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_places</span>]            .<span class="ruby-identifier">filter</span>(<span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;EARLY_MOBILE&quot;</span>)            .<span class="ruby-identifier">filter</span>(<span class="ruby-value">:location_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">location</span>[<span class="ruby-value">:id</span>])            .<span class="ruby-identifier">limit</span>(<span class="ruby-value">1</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">schedule</span> = <span class="ruby-identifier">make_schedule</span>([<span class="ruby-identifier">hours</span>])

      <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_places</span>] <span class="ruby-operator">&lt;&lt;</span> {
        <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;EARLY_MOBILE&quot;</span>,
        <span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Mobile Early Voting Location&quot;</span>,
        <span class="ruby-value">:location_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">location</span>[<span class="ruby-value">:id</span>],
        <span class="ruby-value">:schedule_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">schedule</span>[<span class="ruby-value">:id</span>],
        <span class="ruby-value">:notes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">nil</span>,
      }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">append_schedule</span>(<span class="ruby-identifier">place</span>.<span class="ruby-identifier">get</span>(<span class="ruby-value">:schedule_id</span>), <span class="ruby-identifier">hours</span>)
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div><!-- load_evmobile_places-source -->
          
        </div>

        

        
      </div><!-- load_evmobile_places-method -->

    
      <div id="method-i-make_location" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">make_location</span><span
            class="method-args">(values)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Create an entry in the “voting_locations” table for this location, return
row id.</p>

<p>If the location already exists in the database, will return row id for
existing row.</p>

<p>The “values” list must define: “Name”, “Address”, “City”, “Zipcode”,
“Longitude”, “Latitude”.</p>
          
          

          
          <div class="method-source-code" id="make_location-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 344</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">make_location</span>(<span class="ruby-identifier">values</span>)
  <span class="ruby-identifier">ensure_not_empty</span>(<span class="ruby-identifier">values</span>,
    <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:SITE_NAME</span>],
    <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_ADDRESS</span>],
    <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_CITY</span>],
    <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_ZIP</span>],
    <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_LONGITUDE</span>],
    <span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_LATITUDE</span>])

  <span class="ruby-identifier">lng</span> = <span class="ruby-identifier">values</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_LONGITUDE</span>]].<span class="ruby-identifier">to_f</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;longitude \&quot;#{lng}\&quot; outside of expected range (#{@valid_lng_range}): #{values}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@valid_lng_range</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">lng</span>)

  <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">values</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_LATITUDE</span>]].<span class="ruby-identifier">to_f</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;latitude \&quot;#{lat}\&quot; outside of expected range (#{@valid_lat_range}): #{values}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@valid_lat_range</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">lat</span>)

  <span class="ruby-identifier">zip</span> = <span class="ruby-identifier">values</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_ZIP</span>]]
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad zip value \&quot;Zipcode\&quot;: #{zip}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zip</span> <span class="ruby-operator">=~</span> <span class="ruby-ivar">@valid_zip_regexp</span>

  <span class="ruby-identifier">rec</span> = {
    <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">values</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:SITE_NAME</span>]],
    <span class="ruby-value">:street</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">values</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_ADDRESS</span>]],
    <span class="ruby-value">:city</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">values</span>[<span class="ruby-ivar">@col_name</span>[<span class="ruby-value">:LOCATION_CITY</span>]],
    <span class="ruby-value">:state</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;TX&quot;</span>,
    <span class="ruby-value">:zip</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">zip</span>,
    <span class="ruby-value">:geometry</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">function</span>(<span class="ruby-value">:MakePoint</span>, <span class="ruby-identifier">lng</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-value">4326</span>),
  }

  <span class="ruby-identifier">rec</span>[<span class="ruby-value">:formatted</span>] = <span class="ruby-identifier">rec</span>[<span class="ruby-value">:name</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot;\n&quot;</span>          <span class="ruby-operator">+</span> <span class="ruby-identifier">rec</span>[<span class="ruby-value">:street</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot;\n&quot;</span>          <span class="ruby-operator">+</span> <span class="ruby-identifier">rec</span>[<span class="ruby-value">:city</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot;, &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">rec</span>[<span class="ruby-value">:state</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">rec</span>[<span class="ruby-value">:zip</span>]

  <span class="ruby-identifier">loc</span> = <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_locations</span>]          .<span class="ruby-identifier">filter</span>{<span class="ruby-constant">ST_Equals</span>(<span class="ruby-value">:geometry</span>, <span class="ruby-constant">MakePoint</span>(<span class="ruby-identifier">lng</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-value">4326</span>))}          .<span class="ruby-identifier">first</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">loc</span>
    [<span class="ruby-value">:name</span>, <span class="ruby-value">:street</span>, <span class="ruby-value">:city</span>, <span class="ruby-value">:state</span>, <span class="ruby-value">:zip</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">loc</span>[<span class="ruby-identifier">field</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">rec</span>[<span class="ruby-identifier">field</span>]
        <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;make_location: voting_locations(id #{loc[:id]}): inconsistent \&quot;#{field}\&quot; values [\&quot;#{loc[field]}\&quot;, \&quot;#{rec[field]}\&quot;]&quot;</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">loc</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">id</span> = <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_locations</span>].<span class="ruby-identifier">insert</span>(<span class="ruby-identifier">rec</span>)
  <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_locations</span>][<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- make_location-source -->
          
        </div>

        

        
      </div><!-- make_location-method -->

    
      <div id="method-i-make_schedule" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">make_schedule</span><span
            class="method-args">(hours)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="make_schedule-source">
            <pre><span class="ruby-comment"># File lib/voteatx/loader.rb, line 393</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">make_schedule</span>(<span class="ruby-identifier">hours</span>)
  <span class="ruby-identifier">id</span> = <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_schedules</span>].<span class="ruby-identifier">insert</span>({<span class="ruby-value">:formatted</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">format_schedule</span>(<span class="ruby-identifier">hours</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)})
  <span class="ruby-identifier">hours</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">add_schedule_entry</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">h</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_closed_today</span>(<span class="ruby-identifier">h</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@db</span>[<span class="ruby-value">:voting_schedules</span>][<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- make_schedule-source -->
          
        </div>

        

        
      </div><!-- make_schedule-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 4.0.1.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

